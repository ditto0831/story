<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¯¸ë””ì–´ ì„¤ì •</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        /* --- ê³µí†µ ìŠ¤íƒ€ì¼ --- */
        :root {
            --bg-color: #121212;
            --bg-secondary: #1e1e1e;
            --text-color: #ffffff;
            --text-muted: #a0a0a0;
            --accent-color: #ff4747;
            --border-color: #333333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); line-height: 1.5; height: 100vh; display: flex; flex-direction: column; }

        /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .header-nav {
            background: var(--bg-secondary);
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem;
        }
        .nav-left { display: flex; align-items: center; }
        .step-list { display: flex; gap: 20px; list-style: none; margin-left: 20px; }
        .step-item { color: var(--text-muted); cursor: pointer; position: relative; }
        .step-item.active { color: var(--accent-color); font-weight: bold; }
        .step-item.active::after { content:''; position:absolute; bottom:-14px; left:0; width:100%; height:2px; background:var(--accent-color); }

        /* íŒŒì¼ ì¡°ì‘ ë²„íŠ¼ */
        .file-actions { display: flex; gap: 10px; }
        .btn-file {
            padding: 6px 12px; font-size: 0.85rem; border-radius: 4px; cursor: pointer; border: 1px solid #444; background: #333; color: white;
        }
        .btn-file:hover { background: #444; }

        .container { display: flex; flex: 1; overflow: hidden; }
        .left-panel { flex: 1; padding: 20px; overflow-y: auto; border-right: 1px solid var(--border-color); max-width: 50%; }

        /* í•„í„° íƒ­ */
        .filter-tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .filter-pill {
            padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer;
            border: 1px solid #444; background: transparent; color: #ccc; white-space: nowrap;
        }
        .filter-pill.active { background: #fff; color: #000; border-color: #fff; font-weight: bold; }

        /* ì•ˆë‚´ ë°°ë„ˆ */
        .info-banner {
            background: #2a2a2a; border-radius: 8px; padding: 20px; display: flex; align-items: center; gap: 20px; margin-bottom: 20px;
        }
        .info-bubble {
            background: #fff; color: #000; padding: 10px 15px; border-radius: 12px; font-weight: bold; font-size: 0.9rem; position: relative;
        }
        .info-bubble span { color: #d32f2f; }
        .info-text h4 { font-size: 0.95rem; margin-bottom: 5px; }
        .info-text p { font-size: 0.8rem; color: #aaa; }

        /* ì´ë¯¸ì§€ ì„¤ì • ì¹´ë“œ */
        .image-card {
            background: #252525; border: 1px solid #3d3d3d; border-radius: 8px; padding: 20px; margin-bottom: 15px;
        }
        
        /* ì¹´ë“œ í—¤ë” */
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .img-preview-box { display: flex; gap: 15px; }
        .img-thumbnail {
            width: 80px; height: 80px; background: #333; border-radius: 6px;
            background-size: cover; background-position: center;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="%23555" stroke-width="1"><rect width="24" height="24" fill="%23222"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%23555">IMG</text></svg>');
        }
        .img-info { display: flex; flex-direction: column; justify-content: center; gap: 5px; }
        .img-number { font-weight: bold; font-size: 1rem; }
        .btn-tiny {
            padding: 5px 10px; font-size: 0.75rem; border: 1px solid #555; background: #333; color: #fff; border-radius: 4px; cursor: pointer; margin-right: 5px;
        }
        .card-actions button { background: none; border: none; color: #666; cursor: pointer; margin-left: 8px; font-size: 1rem; }
        .card-actions button:hover { color: #fff; }

        /* í¼ ìš”ì†Œ */
        .form-section { margin-bottom: 20px; }
        .label-row { margin-bottom: 8px; font-size: 0.9rem; font-weight: bold; }
        .label-row span { color: var(--accent-color); }
        .label-desc { font-size: 0.8rem; color: #888; margin-bottom: 8px; display: block; }
        
        .input-box, .textarea-box {
            width: 100%; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-color); padding: 12px; border-radius: 6px; font-size: 0.95rem;
        }
        
        /* íƒœê·¸ ì…ë ¥ ìŠ¤íƒ€ì¼ */
        .tag-input-container {
            width: 100%; background: var(--bg-secondary); border: 1px solid var(--border-color); padding: 8px; border-radius: 6px; display: flex; flex-wrap: wrap; gap: 5px;
        }
        .tag-chip {
            background: #333; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; border: 1px solid #444;
        }

        /* ì´ë¯¸ì§€ ì¶”ê°€ ë²„íŠ¼ */
        .add-image-btn {
            width: 100%; height: 50px; background: transparent; border: 1px solid #444; border-radius: 8px; color: var(--text-color); font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .add-image-btn:hover { background: #252525; border-color: #666; }

        /* --- ì˜¤ë¥¸ìª½ íŒ¨ë„ --- */
        .right-panel { flex: 1; background-color: #000; display: flex; flex-direction: column; position: relative; }
        .preview-header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: rgba(30, 30, 30, 0.8); }
        .chat-area { flex: 1; display: flex; align-items: center; justify-content: center; color: #555; font-size: 0.9rem; }
        .chat-input-area { padding: 20px; }
        .chat-input-wrapper { background: #1e1e1e; border: 1px solid #333; border-radius: 12px; padding: 12px; display: flex; align-items: center; justify-content: space-between; }
        .send-btn { width: 30px; height: 30px; background: #fff; border-radius: 50%; border: none; cursor: pointer; }

        /* í•˜ë‹¨ë°” */
        .bottom-nav { padding: 15px 20px; border-top: 1px solid var(--border-color); background: var(--bg-secondary); display: flex; justify-content: space-between; }
        .btn-prev { background: #333; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .btn-next { background: var(--accent-color); color: white; border: none; padding: 10px 30px; border-radius: 6px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <header class="header-nav">
        <div class="nav-left">
            <div style="font-weight:bold; font-size:1.1rem; margin-right:20px;">â† ìŠ¤í† ë¦¬ ë§Œë“¤ê¸°</div>
            <ul class="step-list">
                <li class="step-item" onclick="saveAndGo('index.html')">í”„ë¡œí•„</li>
                <li class="step-item" onclick="saveAndGo('story.html')">ìŠ¤í† ë¦¬ ì„¤ì •</li>
                <li class="step-item" onclick="saveAndGo('start_setting.html')">ì‹œì‘ ì„¤ì •</li>
                <li class="step-item" onclick="saveAndGo('stat_setting.html')">ìŠ¤íƒ¯ ì„¤ì •</li>
                <li class="step-item active">ë¯¸ë””ì–´</li>
            </ul>
        </div>
        <div class="file-actions">
            <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="loadJsonFile(this)">
            <button class="btn-file" onclick="document.getElementById('jsonFileInput').click()">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="btn-file" onclick="saveJsonFile()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        </div>
    </header>

    <div class="container">
        <aside class="left-panel">
            
            <h2 style="font-size:1.1rem; font-weight:bold; margin-bottom:5px;">ìƒí™© ì´ë¯¸ì§€ <span style="font-size:0.8rem; font-weight:normal; color:#666;">?</span></h2>
            <p style="font-size: 0.85rem; color: #888; margin-bottom: 20px;">ìƒí™©ì— ì–´ìš¸ë¦¬ëŠ” ì¸ë¬¼, ë°°ê²½ ë“±ì˜ ì´ë¯¸ì§€ë¥¼ ë“±ë¡í•´ ë³´ì„¸ìš” (ì‹œì‘ ì„¤ì •ë³„ë¡œ ìµœëŒ€ 50ê°œ)</p>

            <div class="filter-tabs" id="filterTabs">
                <button class="filter-pill active" onclick="filterImages('all')">ì „ì²´</button>
                </div>

            <div class="info-banner">
                <div class="info-bubble">
                    {{img::<span>ì´ë¯¸ì§€ ì´ë¦„</span>}}<br>
                    <span style="font-weight:normal; font-size:0.8rem; color:#333;">ì•ˆë…•í•˜ì„¸ìš”. ë°˜ê°€ì›Œìš”!</span>
                </div>
                <div class="info-text">
                    <h4>ìƒí™© ì´ë¯¸ì§€ë¥¼ ì±„íŒ…ì— ì²¨ë¶€í•´ ë³´ì„¸ìš”</h4>
                    <p>ì½”ë“œ ë³µì‚¬ ë²„íŠ¼ì„ í†µí•´ í”„ë¡¤ë¡œê·¸ì™€ ì „ê°œ ì˜ˆì‹œì— ë„£ì„ ìˆ˜ ìˆì–´ìš”</p>
                </div>
            </div>

            <div id="imageList"></div>

            <button class="add-image-btn" onclick="addImageCard()">
                + ìƒí™© ì´ë¯¸ì§€ ì¶”ê°€
            </button>

        </aside>

        <main class="right-panel">
            <div class="preview-header">
                <span style="font-weight:bold;">â† ì±„íŒ… ë¯¸ë¦¬ë³´ê¸°</span>
                <div style="background:#333; padding:5px 10px; border-radius:20px; font-size:0.8rem;">
                    <span style="color:purple;">â—</span> ìŠˆí¼ì±— 2.0 âˆ¨
                </div>
            </div>
            <div class="chat-area">
                <div style="text-align:center;">
                    <p style="margin-bottom:10px;">ì´ ëŒ€í™”ëŠ” AIë¡œ ìƒì„±ëœ ê°€ìƒì˜ ì´ì•¼ê¸°ì…ë‹ˆë‹¤</p>
                    <div style="background:#1e1e1e; padding:15px; border-radius:8px; width:300px; margin:0 auto; text-align:left;">
                        <span style="display:inline-block; width:15px; height:15px; background:#555; border-radius:50%; margin-right:10px;"></span>
                        <span id="previewName" style="color:#888;">ìŠ¤í† ë¦¬ ì´ë¦„</span>
                    </div>
                </div>
            </div>
            <div class="chat-input-area">
                <div class="chat-input-wrapper">
                    <div style="color:#666; font-size:0.9rem;">[ì´ë¦„, ìºë¦­í„° ì„¤ì • ë° ì •ë³´, ì²« ë©”ì‹œì§€]ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”<br><span style="font-size:1.2rem;">â„ï¸</span></div>
                    <button class="send-btn">â–¶</button>
                </div>
            </div>
        </main>
    </div>

    <footer class="bottom-nav">
        <button class="btn-prev" onclick="saveAndGo('stat_setting.html')">ì´ì „</button>
        <button class="btn-next" onclick="saveAndGo('keyword_book.html')">ë‹¤ìŒ</button>
    </footer>

    <script>
        let globalData = {
            startingSets: [{ name: "ê¸°ë³¸ ì„¤ì •", situationImages: [] }]
        };
        let currentFilter = 'all'; // 'all' or startSetIndex (0, 1, ...)

        window.onload = function() {
            const savedData = localStorage.getItem('storyData');
            if (savedData) {
                globalData = JSON.parse(savedData);
                // ë°ì´í„° ì•ˆì „ì¥ì¹˜
                if (!globalData.startingSets) globalData.startingSets = [{ name: "ê¸°ë³¸ ì„¤ì •", situationImages: [] }];
                globalData.startingSets.forEach(set => {
                    if (!set.situationImages) set.situationImages = [];
                });

                if (globalData.prompt && globalData.prompt.name) {
                    document.getElementById('previewName').innerText = globalData.prompt.name;
                }
                
                renderTabs();
                renderImages();
            }
        };

        // 1. í•„í„° íƒ­ ë Œë”ë§
        function renderTabs() {
            const container = document.getElementById('filterTabs');
            // ì „ì²´ íƒ­ + ê° ì‹œì‘ ì„¤ì • íƒ­
            let html = `<button class="filter-pill ${currentFilter === 'all' ? 'active' : ''}" onclick="changeFilter('all')">ì „ì²´ ${countAllImages()}</button>`;
            
            globalData.startingSets.forEach((set, index) => {
                const count = set.situationImages ? set.situationImages.length : 0;
                const activeClass = currentFilter === index ? 'active' : '';
                html += `<button class="filter-pill ${activeClass}" onclick="changeFilter(${index})">${set.name} ${count}</button>`;
            });
            container.innerHTML = html;
        }

        function countAllImages() {
            return globalData.startingSets.reduce((acc, set) => acc + (set.situationImages ? set.situationImages.length : 0), 0);
        }

        function changeFilter(filter) {
            currentFilter = filter;
            renderTabs();
            renderImages();
        }

        // 2. ì´ë¯¸ì§€ ì¹´ë“œ ë Œë”ë§
        function renderImages() {
            const list = document.getElementById('imageList');
            list.innerHTML = '';

            globalData.startingSets.forEach((set, setIndex) => {
                // í•„í„° ì ìš©
                if (currentFilter !== 'all' && currentFilter !== setIndex) return;

                if (set.situationImages) {
                    set.situationImages.forEach((img, imgIndex) => {
                        addImageCardUI(list, img, setIndex, imgIndex, set.name);
                    });
                }
            });
        }

        // UIì— ì¹´ë“œ ì¶”ê°€ (HTML ìƒì„±)
        function addImageCardUI(container, data, setIndex, imgIndex, setName) {
            const keyword = data.keyword || "";
            const hint = data.hint || "";
            const url = data.url || "";
            const bgStyle = url ? `background-image: url('${url}')` : "";

            const div = document.createElement('div');
            div.className = 'image-card';
            // ë°ì´í„° ì†ì„±ìœ¼ë¡œ ì¸ë±ìŠ¤ ì €ì¥ (ìˆ˜ì • ì‹œ ì°¾ê¸° ìœ„í•´)
            div.dataset.setIndex = setIndex;
            div.dataset.imgIndex = imgIndex;

            div.innerHTML = `
                <div class="card-header">
                    <div class="img-preview-box">
                        <div class="img-thumbnail" style="${bgStyle}"></div>
                        <div class="img-info">
                            <span class="img-number">${imgIndex + 1}</span>
                            <div>
                                <button class="btn-tiny" onclick="promptImageUrl(this)">ì´ë¯¸ì§€ ë³€ê²½</button>
                                <button class="btn-tiny" style="background:transparent; border:1px solid #555;" onclick="copyCode(this)">ì½”ë“œ ë³µì‚¬</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button title="ì‚­ì œ" onclick="removeImage(this)">ğŸ—‘ï¸</button>
                        <button title="ì ‘ê¸°">^</button>
                    </div>
                </div>

                <div class="form-section">
                    <div class="label-row">ìƒí™© <span>*</span></div>
                    <span class="label-desc">ì‘ì„±í•˜ì‹  ìƒí™©ì´ ë˜ë©´ AIê°€ ìë™ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ë„ì›Œë“œë ¤ìš”</span>
                    <textarea class="textarea-box img-keyword" style="height:80px;" placeholder="ì˜ˆ) ê³ ì–‘ì´ ë¯¸ë‰´ê°€ ë†€ë¼ëŠ” ìƒí™©">${keyword}</textarea>
                </div>

                <div class="form-section">
                    <div class="label-row">ì´ë¯¸ì§€ ì ìš© ëŒ€ìƒ <span>*</span></div>
                    <div class="tag-input-container">
                        <div class="tag-chip">${setName}</div>
                    </div>
                </div>

                <div class="form-section" style="margin-bottom:0;">
                    <div class="label-row">ì´ë¯¸ì§€ íŒíŠ¸</div>
                    <span class="label-desc">ìœ ì €ì—ê²Œ ë³´ì—¬ì§ˆ ì´ë¯¸ì§€ í•´ê¸ˆ íŒíŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”</span>
                    <input type="text" class="input-box img-hint" value="${hint}" placeholder="ì˜ˆ) ë­... ë­ëƒ¥?!">
                </div>
            `;
            container.appendChild(div);
        }

        // 3. ìƒˆ ì´ë¯¸ì§€ ì¶”ê°€
        function addImageCard() {
            // í˜„ì¬ í•„í„°ê°€ 'all'ì´ë©´ ì²« ë²ˆì§¸ ì„¸íŠ¸ì—, ì•„ë‹ˆë©´ í•´ë‹¹ ì„¸íŠ¸ì— ì¶”ê°€
            const targetSetIndex = currentFilter === 'all' ? 0 : currentFilter;
            
            if (!globalData.startingSets[targetSetIndex].situationImages) {
                globalData.startingSets[targetSetIndex].situationImages = [];
            }

            // ë¹ˆ ë°ì´í„° ì¶”ê°€
            globalData.startingSets[targetSetIndex].situationImages.push({
                url: "", keyword: "", hint: ""
            });

            saveToLocal(); // ì €ì¥
            renderTabs(); // íƒ­ ì¹´ìš´íŠ¸ ê°±ì‹ 
            renderImages(); // ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
        }

        // ì´ë¯¸ì§€ ì‚­ì œ
        function removeImage(btn) {
            const card = btn.closest('.image-card');
            const sIdx = parseInt(card.dataset.setIndex);
            const iIdx = parseInt(card.dataset.imgIndex);

            globalData.startingSets[sIdx].situationImages.splice(iIdx, 1);
            saveToLocal();
            renderTabs();
            renderImages();
        }

        // ì´ë¯¸ì§€ URL ì…ë ¥ (ê°„ì´ êµ¬í˜„)
        function promptImageUrl(btn) {
            const url = prompt("ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”:");
            if (url) {
                const card = btn.closest('.image-card');
                const sIdx = parseInt(card.dataset.setIndex);
                const iIdx = parseInt(card.dataset.imgIndex);
                
                globalData.startingSets[sIdx].situationImages[iIdx].url = url;
                saveToLocal();
                renderImages();
            }
        }

        // ì €ì¥ ë¡œì§ (ì…ë ¥ê°’ -> globalData ë™ê¸°í™”)
        // ì£¼ì˜: í…ìŠ¤íŠ¸ì—ì–´ë¦¬ì–´/ì¸í’‹ ë³€ê²½ ì‹œ ì‹¤ì‹œê°„ ì €ì¥ì´ ì•„ë‹˜. 
        // í˜ì´ì§€ ì´ë™/ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ ì „ì²´ ì¹´ë“œ í›‘ì–´ì„œ ì—…ë°ì´íŠ¸í•´ì•¼ í•¨.
        function updateGlobalDataFromForm() {
            const cards = document.querySelectorAll('.image-card');
            cards.forEach(card => {
                const sIdx = parseInt(card.dataset.setIndex);
                const iIdx = parseInt(card.dataset.imgIndex);
                
                // ë°ì´í„°ê°€ ìœ íš¨í•œì§€ í™•ì¸
                if (globalData.startingSets[sIdx] && globalData.startingSets[sIdx].situationImages[iIdx]) {
                    const imgObj = globalData.startingSets[sIdx].situationImages[iIdx];
                    imgObj.keyword = card.querySelector('.img-keyword').value;
                    imgObj.hint = card.querySelector('.img-hint').value;
                }
            });
            saveToLocal();
        }

        function saveToLocal() {
            localStorage.setItem('storyData', JSON.stringify(globalData));
        }

        // ê³µí†µ íŒŒì¼ ë¡œë“œ/ì €ì¥/ì´ë™
        function loadJsonFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    globalData = { ...globalData, ...json };
                    saveToLocal();
                    renderTabs();
                    renderImages();
                    alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                } catch (err) { alert('íŒŒì¼ ì˜¤ë¥˜'); }
            };
            reader.readAsText(file);
        }

        function saveJsonFile() {
            updateGlobalDataFromForm();
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(globalData, null, 2));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "story_data.json");
            document.body.appendChild(node);
            node.click();
            node.remove();
        }

        function saveAndGo(url) {
            updateGlobalDataFromForm();
            location.href = url;
        }

        function copyCode(btn) {
            // {{img::ì´ë¦„}} í˜•ì‹ ë³µì‚¬ (ì—¬ê¸°ì„œëŠ” keywordë¥¼ ì´ë¦„ìœ¼ë¡œ ê°€ì •í•˜ê±°ë‚˜ ë³„ë„ í•„ë“œ í•„ìš”)
            // ì„ì‹œë¡œ keywordë¥¼ ë³µì‚¬
            const card = btn.closest('.image-card');
            const key = card.querySelector('.img-keyword').value || "ì´ë¯¸ì§€";
            const code = `{{img::${key}}}`;
            navigator.clipboard.writeText(code).then(() => alert(`ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: ${code}`));
        }
    </script>
</body>
</html>
