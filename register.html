<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤í† ë¦¬ ë“±ë¡</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        /* --- ê³µí†µ ìŠ¤íƒ€ì¼ --- */
        :root {
            --bg-color: #121212;
            --bg-secondary: #1e1e1e;
            --text-color: #ffffff;
            --text-muted: #a0a0a0;
            --accent-color: #ff4747;
            --border-color: #333333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); line-height: 1.5; height: 100vh; display: flex; flex-direction: column; }

        /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .header-nav {
            background: var(--bg-secondary);
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem;
        }
        .nav-left { display: flex; align-items: center; }
        .step-list { display: flex; gap: 20px; list-style: none; margin-left: 20px; }
        .step-item { color: var(--text-muted); cursor: pointer; position: relative; }
        .step-item.active { color: var(--accent-color); font-weight: bold; }
        .step-item.active::after { content:''; position:absolute; bottom:-14px; left:0; width:100%; height:2px; background:var(--accent-color); }

        /* íŒŒì¼ ì¡°ì‘ ë²„íŠ¼ */
        .file-actions { display: flex; gap: 10px; }
        .btn-file {
            padding: 6px 12px; font-size: 0.85rem; border-radius: 4px; cursor: pointer; border: 1px solid #444; background: #333; color: white;
        }
        .btn-file:hover { background: #444; }

        .container { display: flex; flex: 1; overflow: hidden; }
        .left-panel { flex: 1; padding: 20px; overflow-y: auto; border-right: 1px solid var(--border-color); max-width: 50%; }

        /* í¼ ìš”ì†Œ ê³µí†µ */
        .form-section { margin-bottom: 25px; }
        .label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .label-title { font-weight: bold; font-size: 0.9rem; }
        .label-title span { color: var(--accent-color); }
        .label-desc { font-size: 0.8rem; color: #888; margin-bottom: 8px; display: block; }
        
        .input-box, .textarea-box, .select-box {
            width: 100%; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-color); padding: 12px; border-radius: 6px; font-size: 0.95rem; outline: none;
        }
        .textarea-box { resize: vertical; line-height: 1.6; }

        /* íƒœê·¸ ì…ë ¥ ë° ì¹© ìŠ¤íƒ€ì¼ */
        .tag-container {
            display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;
        }
        .tag-chip {
            background: #333; padding: 5px 12px; border-radius: 15px; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; border: 1px solid #444; color: #eee;
        }
        .tag-chip button { background: none; border: none; color: #888; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; }
        .tag-chip button:hover { color: #fff; }

        /* ë°•ìŠ¤í˜• ë¼ë””ì˜¤ ë²„íŠ¼ (ê³µê°œ ì„¤ì • ë“±) */
        .radio-group { display: flex; flex-direction: column; gap: 10px; }
        .radio-box {
            display: flex; align-items: center; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: 0.2s; background: var(--bg-secondary);
        }
        .radio-box:hover { background: #2a2a2a; }
        .radio-box.selected { border-color: var(--accent-color); background: rgba(255, 71, 71, 0.05); }
        
        .radio-input { margin-right: 15px; accent-color: var(--accent-color); transform: scale(1.2); }
        .radio-content { display: flex; flex-direction: column; }
        .radio-label { font-weight: bold; font-size: 0.95rem; margin-bottom: 2px; }
        .radio-desc { font-size: 0.8rem; color: #888; }
        .icon-check { color: #4caf50; margin-right: 5px; }
        .icon-warn { color: #f44336; margin-right: 5px; }

        /* í† ê¸€ ìŠ¤ìœ„ì¹˜ */
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .toggle-switch {
            position: relative; display: inline-block; width: 40px; height: 20px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 20px;
        }
        .slider:before {
            position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- ì˜¤ë¥¸ìª½ íŒ¨ë„ (ìµœì¢… ë¯¸ë¦¬ë³´ê¸°) --- */
        .right-panel { flex: 1; background-color: #000; display: flex; flex-direction: column; }
        .preview-header { padding: 15px; border-bottom: 1px solid #333; font-weight: bold; font-size: 1rem; color: #ccc; background: rgba(30, 30, 30, 0.8); }
        .preview-area { flex: 1; display: flex; align-items: center; justify-content: center; padding: 40px; background: #000; overflow-y: auto; }
        
        /* ìµœì¢… ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .final-card {
            width: 320px; background: #121212; border-radius: 12px; overflow: hidden; border: 1px solid #333;
        }
        .card-image-area {
            width: 100%; height: 320px; background: #333; position: relative;
            background-size: cover; background-position: center;
        }
        
        .like-badge {
            position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.6); color: #fff; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; display: flex; align-items: center; gap: 4px;
        }

        .card-info { padding: 20px; }
        .card-title-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .f-card-title { font-size: 1.2rem; font-weight: bold; color: #fff; }
        .f-card-user { font-size: 0.9rem; color: #888; margin-bottom: 15px; }
        
        .f-tags { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        .f-tag { background: #2a2a2a; color: #ccc; font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; }

        .f-stats { display: flex; gap: 15px; color: #666; font-size: 0.8rem; margin-bottom: 20px; }
        
        .detail-box { background: #1e1e1e; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .detail-label { font-size: 0.8rem; color: #888; margin-bottom: 5px; display: block; }
        .detail-text { font-size: 0.9rem; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .play-btn-large {
            width: 100%; padding: 12px; background: #333; color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px;
        }

        /* í•˜ë‹¨ë°” */
        .bottom-nav { padding: 15px 20px; border-top: 1px solid var(--border-color); background: var(--bg-secondary); display: flex; justify-content: space-between; }
        .btn-prev { background: #333; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .btn-submit { background: var(--accent-color); color: white; border: none; padding: 10px 30px; border-radius: 6px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <header class="header-nav">
        <div class="nav-left">
            <div style="font-weight:bold; font-size:1.1rem; margin-right:20px;">â† ìŠ¤í† ë¦¬ ë§Œë“¤ê¸°</div>
            <ul class="step-list">
                <li class="step-item" onclick="saveAndGo('index.html')">í”„ë¡œí•„</li>
                <li class="step-item" onclick="saveAndGo('story.html')">ìŠ¤í† ë¦¬ ì„¤ì •</li>
                <li class="step-item" onclick="saveAndGo('start_setting.html')">ì‹œì‘ ì„¤ì •</li>
                <li class="step-item" onclick="saveAndGo('stat_setting.html')">ìŠ¤íƒ¯ ì„¤ì •</li>
                <li class="step-item" onclick="saveAndGo('media_setting.html')">ë¯¸ë””ì–´</li>
                <li class="step-item" onclick="saveAndGo('keyword_book.html')">í‚¤ì›Œë“œë¶</li>
                <li class="step-item" onclick="saveAndGo('ending_setting.html')">ì—”ë”© ì„¤ì •</li>
                <li class="step-item active">ë“±ë¡</li>
            </ul>
        </div>
        <div class="file-actions">
            <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="loadJsonFile(this)">
            <button class="btn-file" onclick="document.getElementById('jsonFileInput').click()">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="btn-file" onclick="saveJsonFile()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        </div>
    </header>

    <div class="container">
        <aside class="left-panel">
            
            <div style="margin-bottom: 20px;">
                <h2 style="font-size:1.1rem; margin-bottom:5px;">ìƒì„¸ ì„¤ëª… <span>*</span></h2>
                <span class="label-desc">ìŠ¤í† ë¦¬ì— ëŒ€í•œ êµ¬ì²´ì ì¸ ì„¤ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”</span>
                <textarea id="detailDescInput" class="textarea-box" style="height:120px;" placeholder="ìŠ¤í† ë¦¬ì˜ ì„±ê²©ì´ë‚˜ ì„œì‚¬, ê³¼ê±° ì‚¬ê±´ ë“± ìƒì„¸í•œ ë‚´ìš©ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”"></textarea>
                <div style="text-align:right; font-size:0.8rem; color:#666; margin-top:5px;">0 / 1000</div>
            </div>

            <div class="form-section">
                <div class="label-row"><span class="label-title">ì¥ë¥´ ì„¤ì • <span>*</span></span></div>
                <select id="genreSelect" class="select-box">
                    <option value="">ì¥ë¥´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                    <option value="romance">ë¡œë§¨ìŠ¤</option>
                    <option value="fantasy">íŒíƒ€ì§€</option>
                    <option value="sf">SF</option>
                    <option value="horror">ê³µí¬/ìŠ¤ë¦´ëŸ¬</option>
                </select>
            </div>
            <div class="form-section">
                <div class="label-row"><span class="label-title">íƒ€ê²Ÿ ì„¤ì • <span>*</span></span></div>
                <span class="label-desc">ì„ íƒëœ íƒ€ê²Ÿì— ë”°ë¼ ë‹¤ë¥¸ ì‚¬ìš©ìì—ê²Œ ì¶”ì²œë¼ìš”.</span>
                <select id="targetSelect" class="select-box">
                    <option value="">íƒ€ê²Ÿì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                    <option value="female">ì—¬ì„±í–¥</option>
                    <option value="male">ë‚¨ì„±í–¥</option>
                    <option value="all">ì „ì²´</option>
                </select>
            </div>
            <div class="form-section">
                <div class="label-row"><span class="label-title">ëŒ€í™” í˜•íƒœ ì„¤ì • <span>*</span></span></div>
                <select id="chatTypeSelect" class="select-box">
                    <option value="">ëŒ€í™” í˜•íƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                    <option value="rolePlaying">ì—­í• ë†€ì´</option>
                    <option value="chat">ì¼ìƒëŒ€í™”</option>
                </select>
            </div>
            <div class="form-section">
                <div class="label-row"><span class="label-title">ê¶Œì¥ ëª¨ë“œ <span>*</span></span></div>
                <select class="select-box"><option>ğŸ”® ìŠˆí¼ì±— 2.0 (ê¸°ë³¸)</option></select>
            </div>

            <div class="form-section">
                <div class="label-row"><span class="label-title">í•´ì‹œíƒœê·¸</span></div>
                <span class="label-desc">í•´ì‹œíƒœê·¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”. ë‹¨ì–´ ì…ë ¥ í›„ ì—”í„°ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”. (ìµœëŒ€ 10ê°œ)</span>
                <input type="text" id="hashtagInput" class="input-box" placeholder="ë‹¨ì–´ ì…ë ¥ í›„ ì—”í„°" onkeypress="handleTagInput(event)">
                <div id="tagContainer" class="tag-container">
                    </div>
            </div>

            <div class="form-section">
                <div class="label-row"><span class="label-title">ì´ìš©ì ì¸µ ì„¤ì • <span>*</span></span></div>
                <span class="label-desc">ì´ìš©ì ì¸µì€ í•œë²ˆ ì„¤ì •í•˜ë©´ ë³€ê²½í•  ìˆ˜ ì—†ì–´ìš”.</span>
                <div class="radio-group">
                    <label class="radio-box" id="radioMinor" onclick="selectAge('minor')">
                        <input type="radio" name="age" class="radio-input" value="false">
                        <div class="radio-content">
                            <span class="radio-label"><span class="icon-check">âœ”</span> ë¯¸ì„±ë…„ìê°€ ëŒ€í™”í•˜ê¸°ì— ì ì ˆí•´ìš”</span>
                        </div>
                    </label>
                    <label class="radio-box" id="radioAdult" onclick="selectAge('adult')">
                        <input type="radio" name="age" class="radio-input" value="true">
                        <div class="radio-content">
                            <span class="radio-label"><span class="icon-warn">ğŸ›¡ï¸</span> ë¯¸ì„±ë…„ìê°€ ëŒ€í™”í•˜ê¸°ì— ì ì ˆí•˜ì§€ ì•Šì•„ìš”</span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="form-section">
                <div class="label-row"><span class="label-title">ê³µê°œ ì—¬ë¶€ <span>*</span></span></div>
                <div class="radio-group">
                    <label class="radio-box selected">
                        <input type="radio" name="visibility" class="radio-input" checked>
                        <div class="radio-content">
                            <span class="radio-label">ë¹„ê³µê°œ</span>
                            <span class="radio-desc">ìŠ¤í† ë¦¬ ì œì‘ìë§Œ ì´ ìŠ¤í† ë¦¬ë¥¼ í”Œë ˆì´í•  ìˆ˜ ìˆì–´ìš”</span>
                        </div>
                    </label>
                    </div>
            </div>

        </aside>

        <main class="right-panel">
            <div class="preview-header">ë¯¸ë¦¬ë³´ê¸°</div>
            <div class="preview-area">
                
                <div class="final-card">
                    <div class="card-image-area" id="previewImage">
                        <div class="like-badge">ğŸ‘ 1.6K</div>
                    </div>
                    <div class="card-info">
                        <div class="card-title-row">
                            <span class="f-card-title" id="previewTitle">ìŠ¤í† ë¦¬ ì´ë¦„</span>
                        </div>
                        <div class="f-card-user">@User</div>
                        
                        <div class="f-tags" id="previewTags">
                            </div>
                        
                        <div class="f-stats">
                            <span>ğŸ‘ï¸ 20.2K</span>
                            <span>ğŸ‘ 10.2K</span>
                            <span>ğŸ’¬ 100</span>
                        </div>

                        <div class="detail-box">
                            <span class="detail-label">í”„ë¡¤ë¡œê·¸ ë¯¸ë¦¬ë³´ê¸°</span>
                            <div class="detail-text" id="previewPrologue">ê¸°ë³¸ ì„¤ì •</div>
                        </div>

                        <button class="play-btn-large">í”Œë ˆì´</button>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <footer class="bottom-nav">
        <button class="btn-prev" onclick="saveAndGo('ending_setting.html')">ì´ì „</button>
        <button class="btn-submit" onclick="alert('ìŠ¤í† ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰')">ë“±ë¡í•˜ê¸°</button>
    </footer>

    <script>
        let globalData = {
            prompt: {
                name: "",
                description: "",
                detailDescription: "",
                genre: { name: "" },
                target: "",
                chatType: "",
                tags: [],
                isAdult: false,
                profileImage: { origin: "" }
            },
            startingSets: [{ initialMessages: [] }]
        };

        window.onload = function() {
            const savedData = localStorage.getItem('storyData');
            if (savedData) {
                globalData = JSON.parse(savedData);
                // ë°ì´í„° ì´ˆê¸°í™” ì•ˆì „ì¥ì¹˜
                if (!globalData.prompt) globalData.prompt = { tags: [] };
                if (!globalData.prompt.tags) globalData.prompt.tags = [];
                
                applyDataToForm();
                updatePreview();
            }
        };

        // ë°ì´í„° -> í™”ë©´ ì ìš©
        function applyDataToForm() {
            const p = globalData.prompt;

            // ìƒì„¸ ì„¤ëª… (detailDescriptionì´ ìˆìœ¼ë©´ ê·¸ê²ƒ, ì—†ìœ¼ë©´ description)
            const desc = p.detailDescription || p.description || "";
            document.getElementById('detailDescInput').value = desc;

            // ì¥ë¥´ (JSON: {name: 'ë¡œë§¨ìŠ¤', type: 'romance'}) -> select value ë§¤ì¹­
            // JSON ë°ì´í„°ê°€ í•œê¸€('ë¡œë§¨ìŠ¤')ë¡œ ë“¤ì–´ì˜¤ëŠ”ì§€ ì˜ì–´('romance')ë¡œ ë“¤ì–´ì˜¤ëŠ”ì§€ í™•ì¸ í•„ìš”
            // ì—¬ê¸°ì„œëŠ” type(ì˜ì–´) ê¸°ì¤€ìœ¼ë¡œ ë§¤ì¹­ ì‹œë„
            if (p.genre && p.genre.type) {
                document.getElementById('genreSelect').value = p.genre.type;
            } else if (p.genre && p.genre.name === 'ë¡œë§¨ìŠ¤') {
                 // typeì´ ì—†ê³  í•œê¸€ ì´ë¦„ë§Œ ìˆì„ ê²½ìš° ëŒ€ë¹„
                 document.getElementById('genreSelect').value = 'romance';
            }

            // íƒ€ê²Ÿ
            if (p.target) document.getElementById('targetSelect').value = p.target;

            // ëŒ€í™” í˜•íƒœ
            if (p.chatType) document.getElementById('chatTypeSelect').value = p.chatType;

            // íƒœê·¸ ë Œë”ë§
            renderTags();

            // ì„±ì¸ ì—¬ë¶€ (isAdult: true/false)
            if (p.isAdult) {
                selectAge('adult');
            } else {
                selectAge('minor');
            }
        }

        // íƒœê·¸ ë Œë”ë§ í•¨ìˆ˜
        function renderTags() {
            const container = document.getElementById('tagContainer');
            container.innerHTML = '';
            
            globalData.prompt.tags.forEach((tag, index) => {
                const chip = document.createElement('div');
                chip.className = 'tag-chip';
                chip.innerHTML = `${tag} <button onclick="removeTag(${index})">âœ•</button>`;
                container.appendChild(chip);
            });
            updatePreview(); // íƒœê·¸ ë³€ê²½ ì‹œ ë¯¸ë¦¬ë³´ê¸°ë„ ì—…ë°ì´íŠ¸
        }

        // íƒœê·¸ ì¶”ê°€ (Enterí‚¤)
        function handleTagInput(e) {
            if (e.key === 'Enter') {
                const val = e.target.value.trim();
                if (val && !globalData.prompt.tags.includes(val)) {
                    if (globalData.prompt.tags.length >= 10) {
                        alert('íƒœê·¸ëŠ” ìµœëŒ€ 10ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                        return;
                    }
                    globalData.prompt.tags.push(val);
                    renderTags();
                    e.target.value = '';
                    saveToLocal();
                }
            }
        }

        // íƒœê·¸ ì‚­ì œ
        function removeTag(index) {
            globalData.prompt.tags.splice(index, 1);
            renderTags();
            saveToLocal();
        }

        // ì„±ì¸/ë¯¸ì„±ë…„ì ì„ íƒ UI ì²˜ë¦¬
        function selectAge(type) {
            const minorBtn = document.getElementById('radioMinor');
            const adultBtn = document.getElementById('radioAdult');
            
            if (type === 'adult') {
                adultBtn.classList.add('selected');
                adultBtn.querySelector('input').checked = true;
                minorBtn.classList.remove('selected');
                globalData.prompt.isAdult = true;
            } else {
                minorBtn.classList.add('selected');
                minorBtn.querySelector('input').checked = true;
                adultBtn.classList.remove('selected');
                globalData.prompt.isAdult = false;
            }
            saveToLocal();
        }

        // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updatePreview() {
            const p = globalData.prompt;
            
            // ì œëª©
            if (p.name) document.getElementById('previewTitle').innerText = p.name;

            // ì´ë¯¸ì§€ (1í˜ì´ì§€ì—ì„œ ì„¤ì •í•œ ì´ë¯¸ì§€ URL)
            if (p.profileImage && p.profileImage.origin) {
                document.getElementById('previewImage').style.backgroundImage = `url('${p.profileImage.origin}')`;
            }

            // íƒœê·¸ (ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œì—ëŠ” ìµœëŒ€ 3ê°œ ì •ë„ë§Œ í‘œì‹œ or ì „ì²´ í‘œì‹œ)
            const tagContainer = document.getElementById('previewTags');
            tagContainer.innerHTML = '';
            // ì¥ë¥´ ë¨¼ì € í‘œì‹œ (ì¹© ìŠ¤íƒ€ì¼)
            if (p.genre && p.genre.name) {
                 tagContainer.innerHTML += `<span class="f-tag">ğŸ·ï¸ ${p.genre.name}</span>`;
            }
            // ë‚˜ë¨¸ì§€ íƒœê·¸ë“¤
            if (p.tags) {
                p.tags.slice(0, 3).forEach(tag => { // ê³µê°„ìƒ 3ê°œë§Œ
                     tagContainer.innerHTML += `<span class="f-tag">#${tag}</span>`;
                });
            }

            // í”„ë¡¤ë¡œê·¸ ë¯¸ë¦¬ë³´ê¸° (ì²«ë²ˆì§¸ ì‹œì‘ì„¤ì •ì˜ ì²« ë©”ì‹œì§€)
            if (globalData.startingSets && globalData.startingSets[0] && globalData.startingSets[0].initialMessages) {
                const msgs = globalData.startingSets[0].initialMessages;
                const firstMsg = Array.isArray(msgs) ? msgs[0] : msgs;
                if (firstMsg) {
                     document.getElementById('previewPrologue').innerText = firstMsg;
                }
            }
        }

        // ì €ì¥ ë¡œì§ (ì…ë ¥ê°’ -> ë°ì´í„°)
        function updateGlobalDataFromForm() {
            globalData.prompt.detailDescription = document.getElementById('detailDescInput').value;
            // Select ê°’ë“¤ ì—…ë°ì´íŠ¸ (ë‹¨ìˆœ value ì €ì¥ or êµ¬ì¡°ì²´ ë§¤ì¹­)
            const genreVal = document.getElementById('genreSelect').value;
            const genreText = document.getElementById('genreSelect').options[document.getElementById('genreSelect').selectedIndex].text;
            
            globalData.prompt.genre = { type: genreVal, name: genreText };
            globalData.prompt.target = document.getElementById('targetSelect').value;
            globalData.prompt.chatType = document.getElementById('chatTypeSelect').value;
            
            saveToLocal();
        }

        function saveToLocal() {
            localStorage.setItem('storyData', JSON.stringify(globalData));
        }

        // ê³µí†µ íŒŒì¼ ë¡œë“œ/ì €ì¥/ì´ë™
        function loadJsonFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    globalData = { ...globalData, ...json };
                    saveToLocal();
                    applyDataToForm();
                    updatePreview();
                    alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                } catch (err) { alert('íŒŒì¼ ì˜¤ë¥˜'); }
            };
            reader.readAsText(file);
        }

        function saveJsonFile() {
            updateGlobalDataFromForm();
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(globalData, null, 2));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "story_data.json");
            document.body.appendChild(node);
            node.click();
            node.remove();
        }

        function saveAndGo(url) {
            updateGlobalDataFromForm();
            location.href = url;
        }
    </script>
</body>
</html>
