<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œì‘ ì„¤ì •</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        /* --- ê³µí†µ ìŠ¤íƒ€ì¼ --- */
        :root {
            --bg-color: #121212;
            --bg-secondary: #1e1e1e;
            --text-color: #ffffff;
            --text-muted: #a0a0a0;
            --accent-color: #ff4747;
            --border-color: #333333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); line-height: 1.5; height: 100vh; display: flex; flex-direction: column; }

        /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .header-nav {
            background: var(--bg-secondary);
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem;
        }
        .nav-left { display: flex; align-items: center; }
        .step-list { display: flex; gap: 20px; list-style: none; margin-left: 20px; }
        .step-item { color: var(--text-muted); cursor: pointer; position: relative; }
        .step-item.active { color: var(--accent-color); font-weight: bold; }
        .step-item.active::after { content:''; position:absolute; bottom:-14px; left:0; width:100%; height:2px; background:var(--accent-color); }

        /* íŒŒì¼ ì¡°ì‘ ë²„íŠ¼ */
        .file-actions { display: flex; gap: 10px; }
        .btn-file {
            padding: 6px 12px; font-size: 0.85rem; border-radius: 4px; cursor: pointer; border: 1px solid #444; background: #333; color: white;
        }
        .btn-file:hover { background: #444; }

        .container { display: flex; flex: 1; overflow: hidden; }

        /* --- ì™¼ìª½ íŒ¨ë„ (ì—ë””í„°) --- */
        .left-panel {
            flex: 1; padding: 20px; overflow-y: auto;
            border-right: 1px solid var(--border-color); max-width: 50%;
        }

        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tab-row { display: flex; gap: 10px; margin-bottom: 25px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn {
            padding: 6px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; border: 1px solid transparent; white-space: nowrap;
        }
        .tab-btn.active { background: #fff; color: #000; font-weight: bold; }
        .tab-btn.outline { background: transparent; color: #888; border: 1px solid #444; }
        .tab-btn.outline:hover { border-color: #888; color: #fff; }

        /* í¼ ìš”ì†Œ ìŠ¤íƒ€ì¼ */
        .section-box { margin-bottom: 30px; }
        .label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .label-title { font-weight: bold; font-size: 1rem; }
        .label-title span { color: var(--accent-color); }
        .label-desc { font-size: 0.8rem; color: #888; margin-bottom: 8px; display: block; }

        .btn-small {
            background: #333; color: #fff; border: 1px solid #444;
            padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer;
        }
        .btn-small.red-outline { border: 1px solid var(--accent-color); color: var(--accent-color); background: transparent; }

        .input-box, .textarea-box {
            width: 100%; background: var(--bg-secondary); border: 1px solid var(--border-color);
            color: var(--text-color); padding: 12px; border-radius: 6px; font-size: 0.95rem;
        }
        .textarea-box { height: 120px; resize: vertical; line-height: 1.6; }

        /* ê³ ê¸‰ ì„¤ì • ë°” */
        .advanced-bar {
            background: #252525; padding: 12px; border-radius: 6px;
            font-size: 0.9rem; font-weight: bold; cursor: pointer; margin-bottom: 20px;
            display: flex; justify-content: space-between;
        }
        
        /* ì¶”ì²œ ë‹µë³€ ë¦¬ìŠ¤íŠ¸ */
        .reply-item { display: flex; gap: 10px; margin-bottom: 10px; }
        .reply-input { flex: 1; }
        .btn-del-reply { background: #333; border: 1px solid #444; color: #fff; width: 40px; border-radius: 6px; cursor: pointer; }

        .btn-full {
            width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border-color);
            color: var(--text-muted); border-radius: 6px; cursor: pointer; text-align: center; font-size: 0.9rem;
        }
        .btn-full:hover { background: #333; color: #fff; }

        /* --- ì˜¤ë¥¸ìª½ íŒ¨ë„ (ì±„íŒ… ë¯¸ë¦¬ë³´ê¸° - ë™ì¼ ìœ ì§€) --- */
        .right-panel {
            flex: 1; background-color: #000; display: flex; flex-direction: column; position: relative;
        }
        .preview-header {
            padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: rgba(30, 30, 30, 0.8);
        }
        .chat-area { flex: 1; display: flex; align-items: center; justify-content: center; color: #555; font-size: 0.9rem; }
        .chat-input-area { padding: 20px; }
        .chat-input-wrapper {
            background: #1e1e1e; border: 1px solid #333; border-radius: 12px; padding: 12px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .send-btn { width: 30px; height: 30px; background: #fff; border-radius: 50%; border: none; cursor: pointer; }

        /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .bottom-nav {
            padding: 15px 20px; border-top: 1px solid var(--border-color); background: var(--bg-secondary);
            display: flex; justify-content: space-between;
        }
        .btn-prev { background: #333; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .btn-next { background: var(--accent-color); color: white; border: none; padding: 10px 30px; border-radius: 6px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <header class="header-nav">
        <div class="nav-left">
            <div style="font-weight:bold; font-size:1.1rem; margin-right:20px;">â† ìŠ¤í† ë¦¬ ë§Œë“¤ê¸°</div>
            <ul class="step-list">
                <li class="step-item" onclick="saveAndGo('index.html')">í”„ë¡œí•„</li>
                <li class="step-item" onclick="saveAndGo('story.html')">ìŠ¤í† ë¦¬ ì„¤ì •</li>
                <li class="step-item active">ì‹œì‘ ì„¤ì •</li>
                <li class="step-item" onclick="saveAndGo('stat_setting.html')">ìŠ¤íƒ¯ ì„¤ì •</li>
                <li class="step-item">ë¯¸ë””ì–´</li>
            </ul>
        </div>
        <div class="file-actions">
            <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="loadJsonFile(this)">
            <button class="btn-file" onclick="document.getElementById('jsonFileInput').click()">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="btn-file" onclick="saveJsonFile()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        </div>
    </header>

    <div class="container">
        <aside class="left-panel">
            
            <div class="tab-row" id="tabContainer">
                <button class="tab-btn active">ê¸°ë³¸ ì„¤ì •</button>
                <button class="tab-btn outline">+ ì„¤ì • ì¶”ê°€</button>
            </div>

            <div class="section-box">
                <div class="label-row">
                    <span class="label-title">í”„ë¡¤ë¡œê·¸ <span>*</span></span>
                    <button class="btn-small red-outline">ìë™ ìƒì„±</button>
                </div>
                <span class="label-desc">ìŠ¤í† ë¦¬ì˜ í”„ë¡¤ë¡œê·¸ë¥¼ ì‘ì„±í•´ ì£¼ì„¸ìš”</span>
                <textarea id="prologueInput" class="textarea-box" placeholder="ìë™ ìƒì„± ê¸°ëŠ¥ì„ í™œìš©í•˜ë©´ AIê°€ í”„ë¡¬í”„íŠ¸ë¥¼ ì°¸ê³ í•˜ì—¬ ì´ˆì•ˆì„ ì‘ì„±í•´ ë“œë ¤ìš”"></textarea>
                <div style="text-align:right; font-size:0.8rem; color:#666; margin-top:5px;">0 / 1000</div>
            </div>

            <div class="section-box">
                <div class="label-row">
                    <span class="label-title">ì‹œì‘ì„¤ì • ì´ë¦„ <span>*</span></span>
                </div>
                <span class="label-desc">ì‹œì‘ì„¤ì •ì˜ ì´ë¦„ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”</span>
                <input type="text" id="setNameInput" class="input-box" value="ê¸°ë³¸ ì„¤ì •">
                <div style="text-align:right; font-size:0.8rem; color:#666; margin-top:5px;">5 / 12</div>
            </div>

            <div class="section-box">
                <div class="label-row">
                    <span class="label-title">ì‹œì‘ ìƒí™©</span>
                </div>
                <span class="label-desc">ìŠ¤í† ë¦¬ ì „ê°œë¥¼ ìœ„í•œ ì‹œì‘ ìƒí™© ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”</span>
                <textarea id="situationInput" class="textarea-box" placeholder="ì‚¬ìš©ìì˜ ì—­í• , ë“±ì¥ì¸ë¬¼ê³¼ì˜ ê´€ê³„, ì´ì•¼ê¸°ê°€ ì‹œì‘ë˜ëŠ” ì„¸ê³„ê´€ ë“±"></textarea>
                <div style="text-align:right; font-size:0.8rem; color:#666; margin-top:5px;">0 / 1000</div>
            </div>

            <div class="advanced-bar">
                <span>ê³ ê¸‰ ì„¤ì • âˆ¨</span>
            </div>

            <div class="section-box">
                <div class="label-row">
                    <span class="label-title">í”Œë ˆì´ ê°€ì´ë“œ</span>
                </div>
                <span class="label-desc">AIê°€ ê¸°ì–µí•˜ì§€ ì•ŠëŠ”, ì‚¬ìš©ìì—ê²Œë§Œ ë³´ì´ëŠ” ê°€ì´ë“œ ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•´ í”Œë ˆì´ ë°©ë²•ì„ ì•ˆë‚´í•´ ë³´ì„¸ìš”.</span>
                <textarea id="playGuideInput" class="textarea-box" style="height:80px;" placeholder="ì‚¬ìš©ìë¥¼ ìœ„í•œ ê°€ì´ë“œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”"></textarea>
                <div style="text-align:right; font-size:0.8rem; color:#666; margin-top:5px;">0 / 500</div>
            </div>

            <div class="section-box">
                <div class="label-row">
                    <span class="label-title">ì¶”ì²œ ë‹µë³€</span>
                </div>
                <span class="label-desc">ì‚¬ìš©ìë“¤ì—ê²Œ ì²« ë‹µë³€ì„ ìµœëŒ€ 3ê°œ ì¶”ì²œí•´ ë³´ì„¸ìš”.</span>
                
                <div id="replyList">
                    </div>

                <button class="btn-full" onclick="addReplySuggestion()">+ ì¶”ì²œ ë‹µë³€ ì¶”ê°€</button>
            </div>

        </aside>

        <main class="right-panel">
            <div class="preview-header">
                <span style="font-weight:bold;">â† ì±„íŒ… ë¯¸ë¦¬ë³´ê¸°</span>
                <div style="background:#333; padding:5px 10px; border-radius:20px; font-size:0.8rem;">
                    <span style="color:purple;">â—</span> ìŠˆí¼ì±— 2.0 âˆ¨
                </div>
            </div>
            <div class="chat-area">
                <div style="text-align:center;">
                    <p style="margin-bottom:10px;">ì´ ëŒ€í™”ëŠ” AIë¡œ ìƒì„±ëœ ê°€ìƒì˜ ì´ì•¼ê¸°ì…ë‹ˆë‹¤</p>
                    <div style="background:#1e1e1e; padding:15px; border-radius:8px; width:300px; margin:0 auto; text-align:left;">
                        <span style="display:inline-block; width:15px; height:15px; background:#555; border-radius:50%; margin-right:10px;"></span>
                        <span id="previewName" style="color:#888;">ìŠ¤í† ë¦¬ ì´ë¦„</span>
                    </div>
                </div>
            </div>
            <div class="chat-input-area">
                <div class="chat-input-wrapper">
                    <div style="color:#666; font-size:0.9rem;">
                        [ì´ë¦„, ìºë¦­í„° ì„¤ì • ë° ì •ë³´, ì²« ë©”ì‹œì§€]ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”<br>
                        <span style="font-size:1.2rem;">â„ï¸</span>
                    </div>
                    <button class="send-btn">â–¶</button>
                </div>
            </div>
        </main>
    </div>

    <footer class="bottom-nav">
        <button class="btn-prev" onclick="saveAndGo('story.html')">ì´ì „</button>
        <button class="btn-next" onclick="saveAndGo('stat_setting.html')">ë‹¤ìŒ</button>
    </footer>

    <script>
        // ì „ì—­ ë°ì´í„° (JSON êµ¬ì¡°ì™€ ë™ì¼í•˜ê²Œ ìœ ì§€)
        let globalData = {
            startingSets: [
                {
                    name: "ê¸°ë³¸ ì„¤ì •",
                    initialMessages: [],
                    situationPrompt: "",
                    playGuide: "",
                    replySuggestions: []
                }
            ]
        };
        
        // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ì„¤ì •ì˜ ì¸ë±ìŠ¤ (ê¸°ë³¸ 0)
        let currentSetIndex = 0;

        window.onload = function() {
            const savedData = localStorage.getItem('storyData');
            if (savedData) {
                globalData = JSON.parse(savedData);
                // ë°ì´í„° êµ¬ì¡° ì´ˆê¸°í™” ì•ˆì „ì¥ì¹˜
                if (!globalData.startingSets || globalData.startingSets.length === 0) {
                    globalData.startingSets = [{ name: "ê¸°ë³¸ ì„¤ì •", initialMessages: [], replySuggestions: [] }];
                }
                
                // ë¯¸ë¦¬ë³´ê¸° ì´ë¦„ í‘œì‹œ
                if (globalData.prompt && globalData.prompt.name) {
                    document.getElementById('previewName').innerText = globalData.prompt.name;
                }

                applyDataToForm();
            }
        };

        // ë°ì´í„° -> í™”ë©´ ì ìš©
        function applyDataToForm() {
            const currentSet = globalData.startingSets[currentSetIndex];

            // 1. í”„ë¡¤ë¡œê·¸ (ë°°ì—´ì´ë¯€ë¡œ í•©ì³ì„œ ë³´ì—¬ì¤Œ)
            if (currentSet.initialMessages && currentSet.initialMessages.length > 0) {
                document.getElementById('prologueInput').value = currentSet.initialMessages.join('\n');
            } else {
                document.getElementById('prologueInput').value = "";
            }

            // 2. ì„¤ì • ì´ë¦„
            document.getElementById('setNameInput').value = currentSet.name || "ê¸°ë³¸ ì„¤ì •";

            // 3. ì‹œì‘ ìƒí™©
            document.getElementById('situationInput').value = currentSet.situationPrompt || "";

            // 4. í”Œë ˆì´ ê°€ì´ë“œ
            document.getElementById('playGuideInput').value = currentSet.playGuide || "";

            // 5. ì¶”ì²œ ë‹µë³€ ë¦¬ìŠ¤íŠ¸ ìƒì„±
            const list = document.getElementById('replyList');
            list.innerHTML = ''; // ì´ˆê¸°í™”
            if (currentSet.replySuggestions) {
                currentSet.replySuggestions.forEach(text => {
                    addReplySuggestion(text);
                });
            }
        }

        // ì¶”ì²œ ë‹µë³€ ì…ë ¥ì¹¸ ì¶”ê°€
        function addReplySuggestion(val = "") {
            const list = document.getElementById('replyList');
            const div = document.createElement('div');
            div.className = 'reply-item';
            div.innerHTML = `
                <input type="text" class="input-box reply-val" value="${val}" placeholder="ì¶”ì²œ ë‹µë³€ ì…ë ¥">
                <button class="btn-del-reply" onclick="this.parentElement.remove()">ğŸ—‘ï¸</button>
            `;
            list.appendChild(div);
        }

        // í™”ë©´ -> ë°ì´í„° ì €ì¥
        function updateGlobalDataFromForm() {
            // í˜„ì¬ í™œì„±í™”ëœ ì„¸íŠ¸ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ìƒì„±)
            if (!globalData.startingSets) globalData.startingSets = [];
            if (!globalData.startingSets[currentSetIndex]) globalData.startingSets[currentSetIndex] = {};
            
            const set = globalData.startingSets[currentSetIndex];

            // ê°’ ì—…ë°ì´íŠ¸
            set.name = document.getElementById('setNameInput').value;
            set.situationPrompt = document.getElementById('situationInput').value;
            set.playGuide = document.getElementById('playGuideInput').value;

            // í”„ë¡¤ë¡œê·¸: ì¤„ë°”ê¿ˆ ê¸°ì¤€ìœ¼ë¡œ ë°°ì—´ë¡œ ì €ì¥
            const prologueText = document.getElementById('prologueInput').value;
            set.initialMessages = prologueText ? [prologueText] : [];

            // ì¶”ì²œ ë‹µë³€: ì…ë ¥ëœ ê°’ë“¤ ìˆ˜ì§‘
            const replyInputs = document.querySelectorAll('.reply-val');
            set.replySuggestions = Array.from(replyInputs).map(input => input.value).filter(v => v.trim() !== "");

            // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥
            localStorage.setItem('storyData', JSON.stringify(globalData));
        }

        // ê³µí†µ íŒŒì¼ ë¡œë“œ
        function loadJsonFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    globalData = { ...globalData, ...json };
                    localStorage.setItem('storyData', JSON.stringify(globalData));
                    currentSetIndex = 0; // ë¡œë“œ ì‹œ ì²«ë²ˆì§¸ íƒ­ìœ¼ë¡œ ì´ˆê¸°í™”
                    applyDataToForm();
                    alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                } catch (err) { alert('íŒŒì¼ ì˜¤ë¥˜'); }
            };
            reader.readAsText(file);
        }

        // ê³µí†µ íŒŒì¼ ì €ì¥
        function saveJsonFile() {
            updateGlobalDataFromForm();
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(globalData, null, 2));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "story_data.json");
            document.body.appendChild(node);
            node.click();
            node.remove();
        }

        // í˜ì´ì§€ ì´ë™
        function saveAndGo(url) {
            updateGlobalDataFromForm();
            location.href = url;
        }
    </script>

</body>
</html>
