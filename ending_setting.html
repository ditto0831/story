<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—”ë”© ì„¤ì •</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        /* --- ê³µí†µ ìŠ¤íƒ€ì¼ --- */
        :root {
            --bg-color: #121212;
            --bg-secondary: #1e1e1e;
            --text-color: #ffffff;
            --text-muted: #a0a0a0;
            --accent-color: #ff4747;
            --border-color: #333333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); line-height: 1.5; height: 100vh; display: flex; flex-direction: column; }

        /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .header-nav {
            background: var(--bg-secondary);
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem;
        }
        .nav-left { display: flex; align-items: center; }
        .step-list { display: flex; gap: 20px; list-style: none; margin-left: 20px; }
        .step-item { color: var(--text-muted); cursor: pointer; position: relative; }
        .step-item.active { color: var(--accent-color); font-weight: bold; }
        .step-item.active::after { content:''; position:absolute; bottom:-14px; left:0; width:100%; height:2px; background:var(--accent-color); }

        /* íŒŒì¼ ì¡°ì‘ ë²„íŠ¼ */
        .file-actions { display: flex; gap: 10px; }
        .btn-file {
            padding: 6px 12px; font-size: 0.85rem; border-radius: 4px; cursor: pointer; border: 1px solid #444; background: #333; color: white;
        }
        .btn-file:hover { background: #444; }

        .container { display: flex; flex: 1; overflow: hidden; }
        .left-panel { flex: 1; padding: 20px; overflow-y: auto; border-right: 1px solid var(--border-color); max-width: 50%; }

        /* í•„í„° íƒ­ (ì‹œì‘ ì„¤ì • ì „í™˜ìš©) */
        .filter-tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .filter-pill {
            padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer;
            border: 1px solid #444; background: transparent; color: #ccc; white-space: nowrap;
        }
        .filter-pill.active { background: #fff; color: #000; border-color: #fff; font-weight: bold; }


        /* í¼ ìš”ì†Œ ê³µí†µ */
        .form-section { margin-bottom: 25px; }
        .label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .label-title { font-weight: bold; font-size: 0.9rem; }
        .label-title span { color: var(--accent-color); }
        .label-desc { font-size: 0.8rem; color: #888; margin-bottom: 8px; display: block; }
        
        .input-box, .textarea-box {
            width: 100%; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-color); padding: 12px; border-radius: 6px; font-size: 0.95rem;
        }
        .btn-small { background: #333; color: #fff; border: 1px solid #444; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; }
        .btn-small.red-outline { border: 1px solid var(--accent-color); color: var(--accent-color); background: transparent; }

        /* ì—”ë”© ì œê³µ ì‹œì  */
        .turn-input-row { display: flex; align-items: center; gap: 10px; }
        .turn-input { width: 80px; text-align: right; }

        /* ì—”ë”© ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .ending-card {
            background: #252525; border: 1px solid #3d3d3d; border-radius: 8px; padding: 20px; margin-bottom: 15px;
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #3d3d3d; }
        .card-title { font-weight: bold; font-size: 1rem; border-left: 3px solid #666; padding-left: 10px; }
        .card-actions button { background: none; border: none; color: #666; cursor: pointer; margin-left: 10px; font-size: 1rem; }
        .card-actions button:hover { color: #fff; }

        /* ìŠ¤íƒ¯ ì¶”ê°€í•˜ê¸° ë²„íŠ¼ */
        .stat-add-bar {
            background: #333; padding: 10px; border-radius: 6px; text-align: center; font-size: 0.9rem; color: #ccc; cursor: pointer; margin-top: 5px;
        }
        .stat-add-bar:hover { background: #444; color: #fff; }

        /* ì—”ë”© ì¶”ê°€ ë²„íŠ¼ */
        .add-btn {
            width: 100%; padding: 15px; background: transparent; border: 1px solid #444; border-radius: 6px; color: var(--text-muted); cursor: pointer; transition: 0.2s;
        }
        .add-btn:hover { background: #333; color: #fff; }

        /* --- ì˜¤ë¥¸ìª½ íŒ¨ë„ (ì—í•„ë¡œê·¸ ë¯¸ë¦¬ë³´ê¸°) --- */
        .right-panel { flex: 1; background-color: #000; display: flex; flex-direction: column; }
        .preview-header { padding: 15px; border-bottom: 1px solid #333; font-weight: bold; font-size: 1rem; color: #ccc; background: rgba(30, 30, 30, 0.8); }
        
        .epilogue-area {
            flex: 1; display: flex; align-items: flex-start; justify-content: center; padding: 40px; overflow-y: auto;
        }
        
        .epilogue-preview-card {
            width: 100%; max-width: 500px; background: #1e1e1e; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .ep-header {
            background: #333; color: #aaa; padding: 10px 15px; font-size: 0.8rem; font-weight: bold; letter-spacing: 1px;
        }
        .ep-body { padding: 20px; }
        .ep-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; color: #fff; }
        .ep-desc { font-size: 0.9rem; color: #ccc; line-height: 1.6; white-space: pre-wrap; }

        /* í•˜ë‹¨ë°” */
        .bottom-nav { padding: 15px 20px; border-top: 1px solid var(--border-color); background: var(--bg-secondary); display: flex; justify-content: space-between; }
        .btn-prev { background: #333; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .btn-next { background: var(--accent-color); color: white; border: none; padding: 10px 30px; border-radius: 6px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <header class="header-nav">
        <div class="nav-left">
            <div style="font-weight:bold; font-size:1.1rem; margin-right:20px;">â† ìŠ¤í† ë¦¬ ë§Œë“¤ê¸°</div>
            <ul class="step-list">
                <li class="step-item" onclick="saveAndGo('index.html')">í”„ë¡œí•„</li>
                <li class="step-item" onclick="saveAndGo('story.html')">ìŠ¤í† ë¦¬ ì„¤ì •</li>
                <li class="step-item" onclick="saveAndGo('start_setting.html')">ì‹œì‘ ì„¤ì •</li>
                <li class="step-item" onclick="saveAndGo('stat_setting.html')">ìŠ¤íƒ¯ ì„¤ì •</li>
                <li class="step-item" onclick="saveAndGo('media_setting.html')">ë¯¸ë””ì–´</li>
                <li class="step-item" onclick="saveAndGo('keyword_book.html')">í‚¤ì›Œë“œë¶</li>
                <li class="step-item active">ì—”ë”© ì„¤ì •</li>
                <li class="step-item">ë“±ë¡</li>
            </ul>
        </div>
        <div class="file-actions">
            <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="loadJsonFile(this)">
            <button class="btn-file" onclick="document.getElementById('jsonFileInput').click()">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="btn-file" onclick="saveJsonFile()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        </div>
    </header>

    <div class="container">
        <aside class="left-panel">
            
            <div style="margin-bottom: 20px;">
                <h2 style="font-size:1.1rem; margin-bottom:5px;">ì—”ë”© ì„¤ì •</h2>
                <p style="font-size:0.85rem; color:#888;">ê° ì‹œì‘ ì„¤ì •ì— ë”°ë¥¸ ì—”ë”©ì„ ì„¤ì •í•´ë³´ì„¸ìš”. (ì‹œì‘ì„¤ì • ë³„ ìµœëŒ€ 10ê°œ)</p>
            </div>

            <div class="filter-tabs" id="filterTabs">
                </div>

            <div class="form-section">
                <div class="label-row">
                    <span class="label-title">ì—”ë”© ì œê³µ ì‹œì  <span>*</span></span>
                </div>
                <span class="label-desc">í•´ë‹¹ ì‹œì  ì´í›„ AIê°€ ìƒí™©ì„ íŒë‹¨í•´ ì—”ë”©ì„ ë³´ì—¬ë“œë ¤ìš” (ìµœì†Œ 10í„´ ì´ìƒ)</span>
                <div class="turn-input-row">
                    <input type="number" id="endingTurnInput" class="input-box turn-input" value="30">
                    <span style="font-size:0.9rem;">í„´ ì´ìƒ</span>
                </div>
            </div>

            <div id="endingList"></div>

            <button class="add-btn" onclick="addEndingCard()">+ ì—”ë”© ì¶”ê°€</button>

        </aside>

        <main class="right-panel">
            <div class="preview-header">ë¯¸ë¦¬ë³´ê¸°</div>
            <div class="epilogue-area">
                <div class="epilogue-preview-card">
                    <div class="ep-header">EPILOGUE</div>
                    <div class="ep-body">
                        <div class="ep-title" id="previewTitle">EPILOGUE</div>
                        <div class="ep-desc" id="previewDesc">ìŠ¤í† ë¦¬ì˜ ì—í•„ë¡œê·¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <footer class="bottom-nav">
        <button class="btn-prev" onclick="saveAndGo('keyword_book.html')">ì´ì „</button>
        <button class="btn-next" onclick="saveAndGo('register.html')">ë‹¤ìŒ</button>
    </footer>

    <script>
        let globalData = {
            startingSets: [{ name: "ê¸°ë³¸ ì„¤ì •", endings: [], endingProvideTurn: 30 }]
        };
        let currentSetIndex = 0;

        window.onload = function() {
            const savedData = localStorage.getItem('storyData');
            if (savedData) {
                globalData = JSON.parse(savedData);
                // ë°ì´í„° ì•ˆì „ì¥ì¹˜
                if (!globalData.startingSets) globalData.startingSets = [{ name: "ê¸°ë³¸ ì„¤ì •", endings: [], endingProvideTurn: 30 }];
                globalData.startingSets.forEach(set => {
                    if (!set.endings) set.endings = [];
                    if (!set.endingProvideTurn) set.endingProvideTurn = 30;
                });
                
                renderTabs();
                renderEndings();
            }
        };

        // 1. íƒ­ ë Œë”ë§
        function renderTabs() {
            const container = document.getElementById('filterTabs');
            let html = '';
            
            globalData.startingSets.forEach((set, index) => {
                const count = set.endings ? set.endings.length : 0;
                const activeClass = currentSetIndex === index ? 'active' : '';
                html += `<button class="filter-pill ${activeClass}" onclick="changeSet(${index})">${set.name} ${count}</button>`;
            });
            container.innerHTML = html;
        }

        function changeSet(index) {
            updateCurrentSetData(); // ë³€ê²½ ì „ ì €ì¥
            currentSetIndex = index;
            renderTabs();
            renderEndings();
        }

        // 2. ì—”ë”© ë Œë”ë§
        function renderEndings() {
            const set = globalData.startingSets[currentSetIndex];
            
            // í„´ ìˆ˜ ì…ë ¥
            document.getElementById('endingTurnInput').value = set.endingProvideTurn;

            // ì—”ë”© ì¹´ë“œ ë¦¬ìŠ¤íŠ¸
            const list = document.getElementById('endingList');
            list.innerHTML = '';

            if (set.endings) {
                set.endings.forEach((ending, index) => {
                    addEndingCardUI(list, ending, index);
                });
            }
            
            // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (ì²« ë²ˆì§¸ ì—”ë”© ê¸°ì¤€)
            if (set.endings && set.endings.length > 0) {
                updatePreview(set.endings[0].name, set.endings[0].epilogue);
            } else {
                updatePreview("EPILOGUE", "ìŠ¤í† ë¦¬ì˜ ì—í•„ë¡œê·¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”");
            }
        }

        function addEndingCardUI(container, data, index) {
            const name = data.name || "";
            const condition = data.condition || "";
            const epilogue = data.epilogue || "";
            const hint = data.hint || "";

            const div = document.createElement('div');
            div.className = 'ending-card';
            div.dataset.index = index;

            div.innerHTML = `
                <div class="card-header">
                    <span class="card-title">ì—”ë”© ${index + 1}</span>
                    <div class="card-actions">
                        <button title="ì‚­ì œ" onclick="removeEnding(this)">ğŸ—‘ï¸</button>
                        <button title="ì ‘ê¸°">^</button>
                    </div>
                </div>

                <div class="form-section">
                    <div class="label-row"><span class="label-title">ì—”ë”© ì´ë¦„ <span>*</span></span></div>
                    <input type="text" class="input-box ed-name" value="${name}" placeholder="ì˜ˆ) ë¯¸ë‰´ì˜ í•´í”¼ì—”ë”©" oninput="livePreview(this, 'title')">
                </div>

                <div class="form-section">
                    <div class="label-row"><span class="label-title">ì—”ë”© ê¸°ë³¸ ì¡°ê±´ <span>*</span></span></div>
                    <textarea class="textarea-box ed-condition" style="height:80px;" placeholder="ì—”ë”© ì¡°ê±´ì„ ë¬˜ì‚¬í•´ ì£¼ì„¸ìš”">${condition}</textarea>
                </div>

                <div class="form-section">
                    <div class="label-row">
                        <span class="label-title">ì—í•„ë¡œê·¸ <span>*</span></span>
                        <button class="btn-small red-outline" onclick="alert('ì„œë²„ ì—°ê²° í•„ìš”')">ìë™ìƒì„±</button>
                    </div>
                    <textarea class="textarea-box ed-epilogue" style="height:100px;" placeholder="ì—í•„ë¡œê·¸ ë‚´ìš©ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”" oninput="livePreview(this, 'desc')">${epilogue}</textarea>
                </div>

                <div class="form-section">
                    <div class="label-row"><span class="label-title">ì—”ë”© ì„¸ë¶€ ì¡°ê±´</span></div>
                    <span class="label-desc">â€» í„´ ìˆ˜ì™€ ê´€ê³„ì—†ì´ ì¶©ì¡± ì‹œ ì—”ë”© ë…¸ì¶œ</span>
                    <div class="stat-add-bar" onclick="alert('ìŠ¤íƒ¯ ì„ íƒ íŒì—… (êµ¬í˜„ ì˜ˆì •)')">ìŠ¤íƒ¯ ì¶”ê°€í•˜ê¸° ></div>
                </div>

                <div class="form-section" style="margin-bottom:0;">
                    <div class="label-row"><span class="label-title">ì—”ë”© íŒíŠ¸</span></div>
                    <input type="text" class="input-box ed-hint" value="${hint}" placeholder="ì˜ˆ) ìµìˆ™í•œ ì†Œë¦¬ê°€ ë“¤ë¦°ë‹¤ëƒ¥..!">
                </div>
            `;
            container.appendChild(div);
        }

        // 3. ì—”ë”© ì¶”ê°€/ì‚­ì œ
        function addEndingCard() {
            const set = globalData.startingSets[currentSetIndex];
            if (!set.endings) set.endings = [];
            
            set.endings.push({ name: "", condition: "", epilogue: "", hint: "" });
            
            saveToLocal();
            renderTabs();
            renderEndings();
        }

        function removeEnding(btn) {
            const card = btn.closest('.ending-card');
            const idx = parseInt(card.dataset.index);
            
            globalData.startingSets[currentSetIndex].endings.splice(idx, 1);
            saveToLocal();
            renderTabs();
            renderEndings();
        }

        // 4. ë¯¸ë¦¬ë³´ê¸° ì‹¤ì‹œê°„ ë°˜ì˜
        function livePreview(input, type) {
            const val = input.value;
            if (type === 'title') document.getElementById('previewTitle').innerText = val || "EPILOGUE";
            if (type === 'desc') document.getElementById('previewDesc').innerText = val || "ìŠ¤í† ë¦¬ì˜ ì—í•„ë¡œê·¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”";
        }
        
        function updatePreview(title, desc) {
            document.getElementById('previewTitle').innerText = title || "EPILOGUE";
            document.getElementById('previewDesc').innerText = desc || "ìŠ¤í† ë¦¬ì˜ ì—í•„ë¡œê·¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”";
        }

        // 5. ì €ì¥ ë¡œì§
        function updateCurrentSetData() {
            const set = globalData.startingSets[currentSetIndex];
            
            // í„´ ìˆ˜ ì €ì¥
            set.endingProvideTurn = document.getElementById('endingTurnInput').value;

            // ì¹´ë“œ ë‚´ìš© ì €ì¥
            const cards = document.querySelectorAll('.ending-card');
            cards.forEach(card => {
                const idx = parseInt(card.dataset.index);
                if (set.endings[idx]) {
                    set.endings[idx].name = card.querySelector('.ed-name').value;
                    set.endings[idx].condition = card.querySelector('.ed-condition').value;
                    set.endings[idx].epilogue = card.querySelector('.ed-epilogue').value;
                    set.endings[idx].hint = card.querySelector('.ed-hint').value;
                }
            });
            saveToLocal();
        }

        function saveToLocal() {
            localStorage.setItem('storyData', JSON.stringify(globalData));
        }

        // ê³µí†µ íŒŒì¼ ë¡œë“œ/ì €ì¥/ì´ë™
        function loadJsonFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    globalData = { ...globalData, ...json };
                    currentSetIndex = 0;
                    saveToLocal();
                    renderTabs();
                    renderEndings();
                    alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                } catch (err) { alert('íŒŒì¼ ì˜¤ë¥˜'); }
            };
            reader.readAsText(file);
        }

        function saveJsonFile() {
            updateCurrentSetData();
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(globalData, null, 2));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "story_data.json");
            document.body.appendChild(node);
            node.click();
            node.remove();
        }

        function saveAndGo(url) {
            updateCurrentSetData();
            location.href = url;
        }
    </script>
</body>
</html>
